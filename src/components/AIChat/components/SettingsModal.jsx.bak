import React, { useEffect, useState } from 'react';
import '../../../styles/aichat-settings.css';
import { getTranslationApiConfig, setTranslationApiConfig } from '../../../services/translationService';
import { getImageGenApiConfig, setImageGenApiConfig } from '../../../services/imageGenerationService';
import { openUrl } from '../../../utils/browserUtils';
import { tavilyService } from '../../../services/tavilyService';

export const SettingsModal = ({
  selectedProvider,
  setSelectedProvider,
  selectedModel,
  handleModelChange,
  availableModels,
  apiHost,
  handleApiHostChange,
  apiKey,
  setApiKey,
  showApiKey,
  setShowApiKey,
  handleSettingsClose,
  MODEL_PROVIDERS,
  onImageSettingsUpdate,
  systemPrompt,
  setSystemPrompt,
  systemPromptEnabled,
  setSystemPromptEnabled,
  systemPromptTemplates,
  setSystemPromptTemplates,
  selectedTemplateId,
  setSelectedTemplateId,
  applyTemplate,
  addTemplate,
  updateTemplate,
  deleteTemplate,
  resetTemplates
}) => {
  const [, setForceUpdateState] = useState({});
  const forceUpdate = () => setForceUpdateState({});
  
  // 确保 selectedProvider 是有效的
  const currentProvider = MODEL_PROVIDERS[selectedProvider] || MODEL_PROVIDERS.openai;

  // 添加 tabs 状态
  const [activeTab, setActiveTab] = useState('provider');
  
  // 添加语音合成相关状态
  const [selectedTtsVoice, setSelectedTtsVoice] = useState(() => {
    return localStorage.getItem('aichat_tts_voice') || 'longxiaochun';
  });
  
  // 预设音色列表
  const TTS_VOICES = [
    { id: "longwan", name: "龙婉", language: "中文普通话" },
    { id: "longcheng", name: "龙橙", language: "中文普通话" },
    { id: "longhua", name: "龙华", language: "中文普通话" },
    { id: "longxiaochun", name: "龙小淳", language: "中文+英文" },
    { id: "longxiaoxia", name: "龙小夏", language: "中文" },
    { id: "longxiaocheng", name: "龙小诚", language: "中文+英文" },
    { id: "longxiaobai", name: "龙小白", language: "中文" },
    { id: "longlaotie", name: "龙老铁", language: "中文东北口音" },
    { id: "longshu", name: "龙书", language: "中文" },
    { id: "longshuo", name: "龙硕", language: "中文" },
    { id: "longjing", name: "龙婧", language: "中文" },
    { id: "longmiao", name: "龙妙", language: "中文" },
    { id: "longyue", name: "龙悦", language: "中文" },
    { id: "longyuan", name: "龙媛", language: "中文" },
    { id: "longfei", name: "龙飞", language: "中文" },
    { id: "longjielidou", name: "龙杰力豆", language: "中文+英文" },
    { id: "longtong", name: "龙彤", language: "中文" },
    { id: "longxiang", name: "龙祥", language: "中文" },
    { id: "loongstella", name: "Stella", language: "中文+英文" },
    { id: "loongbella", name: "Bella", language: "中文" }
  ];
  
  // 处理TTS音色变更
  const handleTtsVoiceChange = (voiceId) => {
    setSelectedTtsVoice(voiceId);
    localStorage.setItem('aichat_tts_voice', voiceId);
    
    // 把最新的语音设置也保存到统一的设置对象中供MessageItem使用
    try {
      const ttsSettings = {
        selectedVoice: voiceId,
        lastUpdated: Date.now()
      };
      localStorage.setItem('ttsVoiceSettings', JSON.stringify(ttsSettings));
    } catch (e) {
      console.error('保存TTS设置失败:', e);
    }
    
    console.log(`TTS音色已更改为: ${voiceId}`);
  };
  
  // 添加翻译 API 设置相关状态
  const [translationApiKey, setTranslationApiKey] = useState(() => {
    const { apiKey } = getTranslationApiConfig();
    return apiKey || '';
  });
  
  const [translationApiHost, setTranslationApiHost] = useState(() => {
    const { apiHost } = getTranslationApiConfig();
    return apiHost || 'https://api.siliconflow.cn';
  });
  
  const [showTranslationApiKey, setShowTranslationApiKey] = useState(false);
  
  // 添加 Google Search 相关状态
  const [googleApiKey, setGoogleApiKey] = useState(() => {
    return localStorage.getItem('aichat_google_api_key') || '';
  });
  const [searchEngineId, setSearchEngineId] = useState(() => {
    return localStorage.getItem('aichat_search_engine_id') || '';
  });
  const [showGoogleApiKey, setShowGoogleApiKey] = useState(false);
  
  // 添加最大搜索数量状态
  const [maxSearchResults, setMaxSearchResults] = useState(() => {
    return parseInt(localStorage.getItem('aichat_tavily_max_results')) || 5;
  });

  // 添加消息历史记录数量状态
  const [maxHistoryMessages, setMaxHistoryMessages] = useState(() => {
    const saved = localStorage.getItem('aichat_max_history_messages');
    return saved ? parseInt(saved) : 5;  // 默认5条
  });

  // 添加系统提示词模板编辑状态
  const [editingTemplateId, setEditingTemplateId] = useState(null);
  const [templateName, setTemplateName] = useState('');
  const [templateContent, setTemplateContent] = useState('');
  const [isAddingTemplate, setIsAddingTemplate] = useState(false);

  // 添加生图模型状态
  const [imageModel, setImageModel] = useState(() => {
    return localStorage.getItem('aichat_image_model') || 'black-forest-labs/FLUX.1-schnell';
  });

  // 添加视频模型状态
  const [videoModel, setVideoModel] = useState(() => {
    return localStorage.getItem('aichat_video_model') || 'Lightricks/LTX-Video';
  });

  // 添加视频随机种子状态
  const [videoSeed, setVideoSeed] = useState(() => 
    parseInt(localStorage.getItem('aichat_video_seed')) || Math.floor(Math.random() * 9999999999)
  );

  // 添加图片分辨率状态
  const [imageSize, setImageSize] = useState(() => {
    return localStorage.getItem('aichat_image_size') || '1024x576';
  });

  // 添加 FLUX.1-pro 模型的参数状态
  const [imageWidth, setImageWidth] = useState(() => 
    parseInt(localStorage.getItem('aichat_image_width')) || 1024
  );
  const [imageHeight, setImageHeight] = useState(() => 
    parseInt(localStorage.getItem('aichat_image_height')) || 768
  );
  const [imageSteps, setImageSteps] = useState(() => 
    parseInt(localStorage.getItem('aichat_image_steps')) || 20
  );
  const [imageGuidance, setImageGuidance] = useState(() => 
    parseFloat(localStorage.getItem('aichat_image_guidance')) || 3
  );
  const [imageSafety, setImageSafety] = useState(() => 
    parseInt(localStorage.getItem('aichat_image_safety')) || 2
  );
  const [imageInterval, setImageInterval] = useState(() => 
    parseFloat(localStorage.getItem('aichat_image_interval')) || 2
  );
  const [promptUpsampling, setPromptUpsampling] = useState(() => 
    localStorage.getItem('aichat_prompt_upsampling') === 'true'
  );

  // 添加 FLUX.1-dev 模型的参数状态
  const [devImageSteps, setDevImageSteps] = useState(() => 
    parseInt(localStorage.getItem('aichat_dev_image_steps')) || 20
  );
  const [devPromptEnhancement, setDevPromptEnhancement] = useState(() => 
    localStorage.getItem('aichat_dev_prompt_enhancement') === 'true'
  );

  // 添加其他模型的提示增强状态
  const [sdPromptEnhancement, setSdPromptEnhancement] = useState(() => 
    localStorage.getItem('aichat_sd_prompt_enhancement') === 'true'
  );
  const [schnellPromptEnhancement, setSchnellPromptEnhancement] = useState(() => 
    localStorage.getItem('aichat_schnell_prompt_enhancement') === 'true'
  );

  // 添加图片生成 API 相关状态
  const [imageGenApiKey, setImageGenApiKey] = useState('');
  const [imageGenApiHost, setImageGenApiHost] = useState('');
  const [showImageGenApiKey, setShowImageGenApiKey] = useState(false);

  // 添加 Tavily 相关状态
  const [tavilyApiKey, setTavilyApiKey] = useState(() => {
    return localStorage.getItem('aichat_tavily_api_key') || '';
  });
  const [showTavilyApiKey, setShowTavilyApiKey] = useState(false);
  const [searchTopic, setSearchTopic] = useState(() => {
    return localStorage.getItem('aichat_tavily_topic') || 'general';
  });
  const [searchDepth, setSearchDepth] = useState(() => {
    return localStorage.getItem('aichat_tavily_search_depth') || 'basic';
  });
  const [includeAnswer, setIncludeAnswer] = useState(() => {
    const saved = localStorage.getItem('aichat_tavily_include_answer');
    if (saved === 'true') return 'basic';
    if (saved === 'advanced') return 'advanced';
    return 'none';
  });
  const [timeRange, setTimeRange] = useState(() => {
    return localStorage.getItem('aichat_tavily_time_range') || '';
  });
  const [includeImages, setIncludeImages] = useState(() => {
    return localStorage.getItem('aichat_tavily_include_images') === 'true';
  });
  const [includeImageDescriptions, setIncludeImageDescriptions] = useState(() => {
    return localStorage.getItem('aichat_tavily_include_image_descriptions') === 'true';
  });
  const [includeRawContent, setIncludeRawContent] = useState(() => {
    return localStorage.getItem('aichat_tavily_include_raw_content') === 'true';
  });
  const [days, setDays] = useState(() => {
    return parseInt(localStorage.getItem('aichat_tavily_days') || '3');
  });
  const [includeDomains, setIncludeDomains] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('aichat_tavily_include_domains') || '[]');
    } catch {
      return [];
    }
  });
  const [excludeDomains, setExcludeDomains] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem('aichat_tavily_exclude_domains') || '[]');
    } catch {
      return [];
    }
  });

  // 生图模型列表
  const IMAGE_MODELS = [
    'black-forest-labs/FLUX.1-schnell',
    'black-forest-labs/FLUX.1-dev',
    'black-forest-labs/FLUX.1-pro',
    'stabilityai/stable-diffusion-xl-base-1.0',
    'stabilityai/stable-diffusion-3-5-large',
    'stabilityai/stable-diffusion-3-5-large-turbo',
    'deepseek-ai/Janus-Pro-7B',
    'stabilityai/stable-diffusion-3-medium',
    'stabilityai/stable-diffusion-2-1',
    'Pro/black-forest-labs/FLUX.1-schnell',
    'LoRA/black-forest-labs/FLUX.1-dev',
    'Kwai-Kolors/Kolors'
  ];

  // 视频模型列表
  const VIDEO_MODELS = [
    'Lightricks/LTX-Video',
    'tencent/HunyuanVideo',
    'genmo/mochi-1-preview'
  ];

  // 图片分辨率列表
  const IMAGE_SIZES = [
    // 16:9 分辨率选项
    { value: '1024x576', label: '1024×576 (16:9 横版)' },
    { value: '1280x720', label: '1280×720 (16:9 横版)' },
    // FLUX.1-dev 官方支持的分辨率
    { value: '1024x1024', label: '1024×1024 (1:1 方形)' },
    { value: '960x1280', label: '960×1280 (3:4 竖版)' },
    { value: '768x1024', label: '768×1024 (3:4 竖版)' },
    { value: '720x1440', label: '720×1440 (1:2 竖版)' },
    { value: '720x1280', label: '720×1280 (9:16 竖版)' }
  ];

  // 初始化时加载翻译 API 配置
  useEffect(() => {
    const { apiKey, apiHost } = getTranslationApiConfig();
    setTranslationApiKey(apiKey || '');
    setTranslationApiHost(apiHost || '');
    
    // 加载图片生成 API 配置
    const { apiKey: imgApiKey, apiHost: imgApiHost } = getImageGenApiConfig();
    setImageGenApiKey(imgApiKey || '');
    setImageGenApiHost(imgApiHost || '');
    
    // 加载翻译API配置
    const savedTranslationApiKey = localStorage.getItem('translation_deepseek_api_key') || '';
    const savedTranslationApiHost = localStorage.getItem('translation_deepseek_api_host') || '';
    setTranslationApiKey(savedTranslationApiKey);
    setTranslationApiHost(savedTranslationApiHost);
  }, []);
  
  // 初始化滑动条进度效果
  useEffect(() => {
    // 在初始渲染和标签页切换时都更新滑动条
    const updateAllRanges = () => {
      document.querySelectorAll('.settings-panel .range').forEach(rangeElement => {
        updateRangeProgress(rangeElement);
      });
    };

    // 立即更新一次
    updateAllRanges();
    
    // 延迟后再次更新，确保DOM已完全渲染
    const timer = setTimeout(updateAllRanges, 100);
    
    return () => clearTimeout(timer);
  }, [activeTab, maxHistoryMessages, imageSteps, imageGuidance, imageSafety, imageInterval, devImageSteps]);

  // 处理翻译 API 密钥变更
  const handleTranslationApiKeyChange = (value) => {
    setTranslationApiKey(value);
    setTranslationApiConfig(value, translationApiHost);
  };

  // 处理翻译 API 地址变更
  const handleTranslationApiHostChange = (value) => {
    setTranslationApiHost(value);
    setTranslationApiConfig(translationApiKey, value);
  };

  // 处理翻译 API 密钥粘贴
  const handleTranslationApiKeyPaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      handleTranslationApiKeyChange(text);
    } catch (error) {
      console.error('粘贴失败:', error);
    }
  };

  // 处理 API 密钥变更
  const handleApiKeyChange = (value) => {
    setApiKey(value);
  };

  // 处理粘贴
  const handlePaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      setApiKey(text);
    } catch (error) {
      console.error('粘贴失败:', error);
    }
  };

  // 处理键盘事件
  const handleKeyDown = (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'v') {
      e.preventDefault();
      handlePaste();
    }
  };

  // 处理消息历史记录数量变更
  const handleMaxHistoryMessagesChange = (value) => {
    const numValue = parseInt(value);
    setMaxHistoryMessages(numValue);
    localStorage.setItem('aichat_max_history_messages', numValue.toString());
  };
  
  // 更新滑动条进度效果
  const updateRangeProgress = (rangeElement) => {
    if (!rangeElement) return;
    const min = parseInt(rangeElement.min) || 0;
    const max = parseInt(rangeElement.max) || 100;
    const value = parseInt(rangeElement.value) || min;
    const percentage = ((value - min) / (max - min)) * 100;
    rangeElement.style.setProperty('--range-shdw', `${percentage}%`);
  };

  // 处理生图模型变更
  const handleImageModelChange = (value) => {
    setImageModel(value);
    localStorage.setItem('aichat_image_model', value);
  };

  // 处理图片分辨率变更
  const handleImageSizeChange = (value) => {
    setImageSize(value);
    localStorage.setItem('aichat_image_size', value);
  };

  const openExternalLink = (url) => {
    openUrl(url);
  };

  // 处理模板选择
  const handleTemplateSelect = (templateId) => {
    applyTemplate(templateId);
  };

  // 处理添加模板
  const handleAddTemplate = () => {
    setIsAddingTemplate(true);
    setTemplateName('');
    setTemplateContent(systemPrompt || '');
    setEditingTemplateId(null);
  };

  // 处理编辑模板
  const handleEditTemplate = (template) => {
    setIsAddingTemplate(false);
    setEditingTemplateId(template.id);
    setTemplateName(template.name);
    setTemplateContent(template.content);
  };

  // 处理保存模板
  const handleSaveTemplate = () => {
    if (!templateName.trim()) {
      alert('请输入模板名称');
      return;
    }

    if (!templateContent.trim()) {
      alert('请输入模板内容');
      return;
    }

    if (isAddingTemplate) {
      const newTemplateId = addTemplate(templateName, templateContent);
      setSelectedTemplateId(newTemplateId);
    } else if (editingTemplateId) {
      updateTemplate(editingTemplateId, templateName, templateContent);
    }

    // 重置编辑状态
    setIsAddingTemplate(false);
    setEditingTemplateId(null);
    setTemplateName('');
    setTemplateContent('');
  };

  // 处理取消编辑模板
  const handleCancelEditTemplate = () => {
    setIsAddingTemplate(false);
    setEditingTemplateId(null);
    setTemplateName('');
    setTemplateContent('');
  };

  // 处理删除模板
  const handleDeleteTemplate = (templateId) => {
    if (confirm('确定要删除此模板吗？')) {
      deleteTemplate(templateId);
    }
  };

  // 修改 collectMediaSettings 函数
  const collectMediaSettings = () => {
    const imageSettings = {
      model: imageModel,
      ...(imageModel === 'black-forest-labs/FLUX.1-pro' ? {
        width: 1024,
        height: 768,
        steps: imageSteps,
        guidance: imageGuidance,
        safety_tolerance: imageSafety,
        interval: imageInterval,
        prompt_upsampling: promptUpsampling
      } : imageModel === 'black-forest-labs/FLUX.1-dev' ? {
        image_size: imageSize,
        num_inference_steps: devImageSteps,
        prompt_enhancement: devPromptEnhancement
      } : imageModel.includes('stable-diffusion-3') ? {
        image_size: imageSize,
        prompt_enhancement: sdPromptEnhancement
      } : imageModel.includes('FLUX.1-schnell') ? {
        image_size: imageSize,
        prompt_enhancement: schnellPromptEnhancement
      } : {
        image_size: imageSize
      })
    };

    const videoSettings = {
      model: videoModel,
      seed: videoSeed
    };
    
    return {
      image: imageSettings,
      video: videoSettings
    };
  };

  // 修改关闭处理函数
  const handleClose = () => {
    // 收集并更新媒体设置
    const mediaSettings = collectMediaSettings();
    onImageSettingsUpdate?.(mediaSettings);
    
    // 保存域名设置到localStorage
    // 过滤掉空字符串，确保存储有效域名
    const filteredIncludeDomains = includeDomains.filter(domain => domain.trim() !== '');
    const filteredExcludeDomains = excludeDomains.filter(domain => domain.trim() !== '');
    
    localStorage.setItem('aichat_tavily_include_domains', JSON.stringify(filteredIncludeDomains));
    localStorage.setItem('aichat_tavily_exclude_domains', JSON.stringify(filteredExcludeDomains));
    
    // 确保其他Tavily设置也被保存
    // 处理includeAnswer (已在onChange函数中处理，这里是备份)
    let answerValue;
    if (includeAnswer === 'none') {
      answerValue = 'false';
    } else if (includeAnswer === 'basic') {
      answerValue = 'true';
    } else if (includeAnswer === 'advanced') {
      answerValue = 'advanced';
    }
    localStorage.setItem('aichat_tavily_include_answer', answerValue);
    
    // 保存其他设置
    localStorage.setItem('aichat_tavily_search_depth', searchDepth);
    localStorage.setItem('aichat_tavily_topic', searchTopic);
    localStorage.setItem('aichat_tavily_time_range', timeRange);
    localStorage.setItem('aichat_tavily_include_images', includeImages.toString());
    localStorage.setItem('aichat_tavily_include_image_descriptions', includeImageDescriptions.toString());
    localStorage.setItem('aichat_tavily_include_raw_content', includeRawContent.toString());
    localStorage.setItem('aichat_tavily_days', days.toString());
    
    console.log('已保存所有Tavily搜索设置');
    
    // 调用原有的关闭处理函数
    handleSettingsClose();
  };

  // 处理图片生成 API 密钥变更
  const handleImageGenApiKeyChange = (value) => {
    setImageGenApiKey(value);
    setImageGenApiConfig(value, imageGenApiHost);
  };

  // 处理图片生成 API 地址变更
  const handleImageGenApiHostChange = (value) => {
    setImageGenApiHost(value);
    setImageGenApiConfig(imageGenApiKey, value);
  };

  // 处理图片生成 API 密钥粘贴
  const handleImageGenApiKeyPaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (text) {
        setImageGenApiKey(text);
        setImageGenApiConfig(text, imageGenApiHost);
      }
    } catch (error) {
      console.error('粘贴失败:', error);
    }
  };

  // 处理 Tavily API 密钥变更
  const handleTavilyApiKeyChange = (value) => {
    setTavilyApiKey(value);
    localStorage.setItem('aichat_tavily_api_key', value);
  };

  // 处理 Tavily API 密钥粘贴
  const handleTavilyApiKeyPaste = async () => {
    try {
      const text = await navigator.clipboard.readText();
      handleTavilyApiKeyChange(text);
    } catch (error) {
      console.error('粘贴失败:', error);
    }
  };

  // 处理搜索主题变更
  const handleSearchTopicChange = (value) => {
    setSearchTopic(value);
    localStorage.setItem('aichat_tavily_topic', value);
  };

  // 处理搜索深度变更
  const handleSearchDepthChange = (value) => {
    setSearchDepth(value);
    localStorage.setItem('aichat_tavily_search_depth', value);
  };

  // 处理包含答案变更
  const handleIncludeAnswerChange = (value) => {
    setIncludeAnswer(value);
    
    // 将UI值映射到API需要的格式并保存
    let storageValue;
    if (value === 'none') {
      storageValue = 'false';
    } else if (value === 'basic') {
      storageValue = 'true';
    } else if (value === 'advanced') {
      storageValue = 'advanced';
    }
    
    localStorage.setItem('aichat_tavily_include_answer', storageValue);
    console.log('已保存includeAnswer设置:', value, '->存储为:', storageValue);
  };

  // 处理包含域名变更
  const handleIncludeDomainChange = (index, value) => {
    const newIncludeDomains = [...includeDomains];
    newIncludeDomains[index] = value;
    setIncludeDomains(newIncludeDomains);
  };

  // 处理移除包含域名
  const handleRemoveIncludeDomain = (index) => {
    const newIncludeDomains = includeDomains.filter((_, i) => i !== index);
    setIncludeDomains(newIncludeDomains);
  };

  // 处理添加包含域名
  const handleAddIncludeDomain = () => {
    setIncludeDomains([...includeDomains, '']);
  };

  // 处理排除域名变更
  const handleExcludeDomainChange = (index, value) => {
    const newExcludeDomains = [...excludeDomains];
    newExcludeDomains[index] = value;
    setExcludeDomains(newExcludeDomains);
  };

  // 处理移除排除域名
  const handleRemoveExcludeDomain = (index) => {
    const newExcludeDomains = excludeDomains.filter((_, i) => i !== index);
    setExcludeDomains(newExcludeDomains);
  };

  // 处理添加排除域名
  const handleAddExcludeDomain = () => {
    setExcludeDomains([...excludeDomains, '']);
  };

  // 处理最大搜索数量变更
  const handleMaxSearchResultsChange = (value) => {
    const numValue = parseInt(value);
    setMaxSearchResults(numValue);
    localStorage.setItem('aichat_tavily_max_results', numValue.toString());
  };

  // 添加测试Tavily API的函数
  const handleTestTavilyAPI = async () => {
    try {
      // 显示测试中状态
      window.message.loading({
        content: '正在测试Tavily API...',
        key: 'tavily-test'
      });
      
      // 执行测试
      const result = await tavilyService.testSearch();
      
      if (result.success) {
        window.message.success({
          content: '测试成功！Tavily API工作正常',
          key: 'tavily-test'
        });
      } else {
        window.message.error({
          content: result.message || '测试失败，请检查API密钥和网络连接',
          key: 'tavily-test'
        });
      }
    } catch (error) {
      window.message.error({
        content: `测试失败: ${error.message}`,
        key: 'tavily-test'
      });
    }
  };

  // 处理时间范围变更
  const handleTimeRangeChange = (value) => {
    setTimeRange(value);
    localStorage.setItem('aichat_tavily_time_range', value);
  };

  // 处理包含图片变更
  const handleIncludeImagesChange = (value) => {
    setIncludeImages(value);
    localStorage.setItem('aichat_tavily_include_images', value.toString());
  };

  // 处理包含图片描述变更
  const handleIncludeImageDescriptionsChange = (value) => {
    setIncludeImageDescriptions(value);
    localStorage.setItem('aichat_tavily_include_image_descriptions', value.toString());
  };

  // 处理包含原始内容变更
  const handleIncludeRawContentChange = (value) => {
    setIncludeRawContent(value);
    localStorage.setItem('aichat_tavily_include_raw_content', value.toString());
  };

  // 处理天数变更
  const handleDaysChange = (value) => {
    setDays(value);
    localStorage.setItem('aichat_tavily_days', value.toString());
  };

  // 添加自定义Voice ID的状态
  const [customVoiceId, setCustomVoiceId] = useState(() => 
    localStorage.getItem('aichat_custom_voice_id') || ''
  );
  const [useCustomVoice, setUseCustomVoice] = useState(() => 
    localStorage.getItem('aichat_use_custom_voice') === 'true'
  );

  return (
    <div className="fixed inset-0 settings-modal-backdrop flex items-center justify-center z-50">
      <div className="settings-panel rounded-lg w-[650px] max-h-[80vh] overflow-y-auto">
        {/* 标题和关闭按钮 */}
        <div className="flex justify-between items-center mb-6 px-2">
          <h1 className="text-2xl font-bold">Settings</h1>
          <button 
            type="button"
            className="close-btn"
            onClick={handleClose}
          >
            ✕
          </button>
        </div>

        {/* Tabs */}
        <div className="space-y-4 px-2">
          {/* 标签页 */}
          <div className="tabs">
            <a 
              className={`tab ${activeTab === 'provider' ? 'tab-active' : ''}`}
              onClick={() => setActiveTab('provider')}
            >
              API
            </a>
            <a 
              className={`tab ${activeTab === 'system' ? 'tab-active' : ''}`}
              onClick={() => setActiveTab('system')}
            >
              Prompt
            </a>
            <a 
              className={`tab ${activeTab === 'media_gen' ? 'tab-active' : ''}`}
              onClick={() => setActiveTab('media_gen')}
            >
              Media
            </a>
            <a 
              className={`tab ${activeTab === 'search' ? 'tab-active' : ''}`}
              onClick={() => setActiveTab('search')}
            >
              Search
            </a>
            <a 
              className={`tab ${activeTab === 'interactive' ? 'tab-active' : ''}`}
              onClick={() => setActiveTab('interactive')}
            >
              Interactive
            </a>
          </div>
          
          {/* Tab 1: 模型设置 */}
          <div className={activeTab === 'provider' ? '' : 'hidden'}>
            {/* 模型提供方 */}
            <div className="mb-4">
              <h3 className="text-lg font-bold mb-2">模型提供方</h3>
              <select 
                className="select select-bordered w-full"
                value={selectedProvider}
                onChange={(e) => setSelectedProvider(e.target.value)}
              >
                {Object.entries(MODEL_PROVIDERS).map(([key, provider]) => (
                  <option key={key} value={key}>{provider.name}</option>
                ))}
              </select>
            </div>

            {/* 具体模型选择 */}
            <div className="mb-4">
              <h3 className="text-lg font-medium mb-2">模型</h3>
              <select 
                className="select select-bordered w-full"
                value={selectedModel}
                onChange={(e) => handleModelChange(e.target.value)}
              >
                {availableModels
                  .filter(model => !IMAGE_MODELS.includes(model))
                  .map(model => (
                  <option key={model} value={model}>{model}</option>
                  ))
                }
              </select>
            </div>

            {/* API 设置 */}
            <div className="space-y-4 px-0">
              {/* API Host */}
              <div>
                <div className="form-control w-full max-w-full">
                  <label className="label">
                    <span className="label-text font-medium text-base">API 地址</span>
                  </label>
                  <input
                    type="text"
                    className="input input-bordered w-full h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary"
                    value={apiHost}
                    onChange={(e) => handleApiHostChange(e.target.value)}
                    placeholder="请输入 API 地址..."
                  />
                  <label className="label">
                    <span className="label-text-alt text-opacity-70">例如：https://api.openai.com</span>
                  </label>
                </div>
              </div>

              {/* API Key */}
              <div>
                <div className="form-control w-full max-w-none">
                  <label className="label">
                    <span className="label-text font-medium text-base">API 密钥</span>
                    {currentProvider.needsApiKey && (
                      <span className="label-text-alt text-error">必填</span>
                    )}
                  </label>
                  <div className="input-group w-full max-w-none flex">
                    <input
                      type={showApiKey ? "text" : "password"}
                      className="input input-bordered flex-grow h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary min-w-0"
                      value={apiKey}
                      onChange={(e) => handleApiKeyChange(e.target.value)}
                      placeholder={`请输入 ${currentProvider.name} API 密钥...`}
                      onKeyDown={handleKeyDown}
                    />
                    <button 
                      type="button"
                      className="btn btn-square btn-outline h-11 min-w-[3.5rem]"
                      onClick={handlePaste}
                      title="点击粘贴"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                      </svg>
                    </button>
                    <button 
                      type="button"
                      className="btn btn-square btn-outline h-11 min-w-[3.5rem]"
                      onClick={() => setShowApiKey(!showApiKey)}
                      title={showApiKey ? "隐藏密钥" : "显示密钥"}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                  </div>
                  {currentProvider.apiKeyHelp && (
                    <label className="label">
                      <span className="label-text-alt flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        {currentProvider.apiKeyHelp.split(': ').map((part, index, array) => {
                          if (index === array.length - 1) {
                            return (
                              <a
                                key={index}
                                className="text-primary hover:text-primary-focus cursor-pointer"
                                onClick={() => openExternalLink(part.trim())}
                              >
                                {part.trim()}
                              </a>
                            );
                          }
                          return part + ': ';
                        })}
                      </span>
                    </label>
                  )}
                </div>
              </div>
              
              {/* 翻译设置 */}
              <div className="divider my-6"></div>
              <div className="space-y-4 px-0">
                <h3 className="text-lg font-medium">翻译设置</h3>
                
                {/* 翻译 API 主机地址 */}
                <div className="mb-4">
                  <div className="form-control w-full max-w-none">
                    <label className="label">
                      <span className="label-text font-medium text-base">DeepSeek API 地址</span>
                    </label>
                    <input
                      type="text"
                      className="input input-bordered w-full h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary"
                      value={translationApiHost}
                      onChange={(e) => handleTranslationApiHostChange(e.target.value)}
                      placeholder="https://api.deepseek.com"
                    />
                    <label className="label">
                      <span className="label-text-alt text-opacity-70">翻译功能使用的 DeepSeek API 地址</span>
                    </label>
                  </div>
                </div>
                
                {/* 翻译 API 密钥 */}
                <div className="mb-4">
                  <div className="form-control w-full max-w-none">
                    <label className="label">
                      <span className="label-text font-medium text-base">DeepSeek API 密钥</span>
                    </label>
                    <div className="input-group w-full max-w-none flex">
                      <input
                        type={showTranslationApiKey ? "text" : "password"}
                        className="input input-bordered flex-grow h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary min-w-0"
                        value={translationApiKey}
                        onChange={(e) => handleTranslationApiKeyChange(e.target.value)}
                        placeholder="请输入用于翻译功能的 DeepSeek API 密钥..."
                      />
                      <button 
                        type="button"
                        className="btn btn-square btn-outline h-11 min-w-[3.5rem]"
                        onClick={handleTranslationApiKeyPaste}
                        title="点击粘贴"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                      </button>
                      <button 
                        type="button"
                        className="btn btn-square btn-outline h-11 min-w-[3.5rem]"
                        onClick={() => setShowTranslationApiKey(!showTranslationApiKey)}
                        title={showTranslationApiKey ? "隐藏密钥" : "显示密钥"}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showTranslationApiKey ? "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" : "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"} />
                        </svg>
                      </button>
                    </div>
                    <label className="label">
                      <span className="label-text-alt text-opacity-70">DeepSeek API 密钥，用于翻译功能</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Tab 2: 系统提示词设置 */}
          <div className={activeTab === 'system' ? '' : 'hidden'}>
            <div className="space-y-4">
              {/* 原有的系统提示词设置 */}
              <div>
                <h3 className="text-lg font-medium mb-2">系统提示词</h3>
                <div className="form-control bg-base-200 rounded-lg p-3">
                  <label className="label cursor-pointer">
                    <span className="label-text font-medium">启用系统提示词</span>
                    <input
                      type="checkbox"
                      className="toggle toggle-primary"
                      checked={systemPromptEnabled}
                      onChange={(e) => setSystemPromptEnabled(e.target.checked)}
                    />
                  </label>
                  <div className="text-xs opacity-70 mt-1">
                    启用后，系统提示词将应用于所有对话，帮助AI更好地理解你的需求
                  </div>
                </div>
              </div>

              {/* 当前使用的模板信息 */}
              <div>
                <h3 className="text-lg font-medium mb-2">当前模板</h3>
                <div className="bg-base-200 p-3 rounded-lg">
                  <div className="font-medium">
                    {selectedTemplateId ? 
                      systemPromptTemplates.find(t => t.id === selectedTemplateId)?.name || '小葵女友模式' 
                      : '小葵女友模式'}
                  </div>
                </div>
              </div>

              {/* 系统提示词编辑 */}
              <div>
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-lg font-medium">系统提示词内容</h3>
                </div>
                <textarea
                  className="textarea textarea-bordered w-full h-32"
                  value={systemPrompt}
                  onChange={(e) => setSystemPrompt(e.target.value)}
                  placeholder="输入系统提示词..."
                  disabled={!systemPromptEnabled}
                />
                <div className="text-xs opacity-70 mt-2">
                  系统提示词会在每次对话开始时发送给AI，用于设定AI的行为和回答方式
                </div>
              </div>

              {/* 模板管理 */}
              <div>
                <div className="flex justify-between items-center mb-2">
                  <h3 className="text-lg font-medium">模板管理</h3>
                  <button 
                    className="btn btn-sm gold-save-btn add-template-btn"
                    onClick={handleAddTemplate}
                    disabled={!systemPromptEnabled}
                  >
                    添加新模板
                  </button>
                </div>
                
                <div className="space-y-2 max-h-[200px] overflow-y-auto">
                  {systemPromptTemplates.map(template => (
                    <div key={template.id} className="flex justify-between items-center p-2 bg-base-200 rounded-lg">
                      <div className="flex-1 truncate">{template.name}</div>
                      <div className="flex gap-2">
                        <button 
                          className="btn btn-xs btn-outline"
                          onClick={() => handleTemplateSelect(template.id)}
                          disabled={selectedTemplateId === template.id}
                        >
                          使用
                        </button>
                        <button 
                          className="btn btn-xs btn-ghost"
                          onClick={() => handleEditTemplate(template)}
                        >
                          编辑
                        </button>
                        <button 
                          className="btn btn-xs btn-ghost text-error"
                          onClick={() => handleDeleteTemplate(template.id)}
                        >
                          删除
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="mt-2">
                  <button 
                    className="btn btn-sm btn-outline"
                    onClick={resetTemplates}
                  >
                    重置为默认模板
                  </button>
                </div>
              </div>
            </div>
          </div>

          {/* Tab 3: 媒体生成设置 */}
          <div className={activeTab === 'media_gen' ? '' : 'hidden'}>
            <div className="space-y-6">
              {/* 图片生成API设置 */}
              <div className="space-y-4">
                {/* SiliconFlow API 地址 */}
                <div>
                  <div className="form-control w-full max-w-none">
                    <label className="label">
                      <span className="label-text font-medium text-base">SiliconFlow API 地址</span>
                    </label>
                    <input 
                      type="text" 
                      className="input input-bordered w-full h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary" 
                      value={imageGenApiHost}
                      onChange={(e) => handleImageGenApiHostChange(e.target.value)}
                      placeholder="https://api.siliconflow.cn"
                    />
                    <label className="label">
                      <span className="label-text-alt text-opacity-70">媒体生成功能使用的API地址</span>
                    </label>
                  </div>
                </div>

                {/* SiliconFlow API 密钥 */}
                <div>
                  <div className="form-control w-full max-w-none">
                    <label className="label">
                      <span className="label-text font-medium text-base">SiliconFlow API 密钥</span>
                    </label>
                    <div className="input-group w-full max-w-none flex">
                      <input 
                        type={showImageGenApiKey ? "text" : "password"} 
                        className="input input-bordered flex-grow h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary min-w-0" 
                        value={imageGenApiKey}
                        onChange={(e) => handleImageGenApiKeyChange(e.target.value)}
                        placeholder="sk-..."
                      />
                      <button 
                        className="btn btn-square btn-outline h-11 min-w-[3.5rem]" 
                        onClick={handleImageGenApiKeyPaste}
                        title="点击粘贴"
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                      </button>
                      <button 
                        className="btn btn-square btn-outline h-11 min-w-[3.5rem]" 
                        onClick={() => setShowImageGenApiKey(!showImageGenApiKey)}
                        title={showImageGenApiKey ? "隐藏密钥" : "显示密钥"}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showImageGenApiKey ? "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" : "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"} />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div className="divider"></div>

              {/* 图片参数设置 */}
              <div className="space-y-4">
                <h3 className="text-xl font-bold">图片参数设置</h3>
                
                {/* 生图模型选择 */}
                <div>
                  <h3 className="text-lg font-medium mb-2">生图模型</h3>
                  <select 
                    className="select select-bordered w-full"
                    value={imageModel}
                    onChange={(e) => handleImageModelChange(e.target.value)}
                  >
                    {IMAGE_MODELS.map(model => (
                      <option key={model} value={model}>{model}</option>
                    ))}
                  </select>
                  <div className="text-xs opacity-70 mt-2">
                    选择用于图片生成的模型，使用 /image 命令时会使用此模型
                    {imageModel === 'black-forest-labs/FLUX.1-pro' && (
                      <div className="mt-1 text-info">
                        使用固定分辨率：1024×768
                      </div>
                    )}
                  </div>
                </div>

                {/* 根据不同的模型显示不同的设置选项 */}
                {imageModel === 'black-forest-labs/FLUX.1-pro' ? (
                  <>
                    {/* 步数设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">步数 (Steps)</h3>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="2"
                          max="50"
                          step="1"
                          value={imageSteps}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            setImageSteps(value);
                            localStorage.setItem('aichat_image_steps', value.toString());
                            updateRangeProgress(e.target);
                          }}
                          className="range range-primary flex-1"
                          style={{"--range-shdw": `${((imageSteps - 2) / (50 - 2)) * 100}%`}}
                          onInput={(e) => updateRangeProgress(e.target)}
                        />
                        <div className="w-12 text-center font-medium bg-base-200 px-2 py-1 rounded">
                          {imageSteps}
                        </div>
                      </div>
                      <div className="text-xs opacity-70 mt-1">生成步数范围：2-50，步数越高，生成质量越好，但速度更慢</div>
                    </div>

                    {/* 引导系数设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">引导系数 (Guidance)</h3>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="1.5"
                          max="5"
                          step="0.1"
                          value={imageGuidance}
                          onChange={(e) => {
                            const value = parseFloat(e.target.value);
                            setImageGuidance(value);
                            localStorage.setItem('aichat_image_guidance', value.toString());
                            updateRangeProgress(e.target);
                          }}
                          className="range range-primary flex-1"
                          style={{"--range-shdw": `${((imageGuidance - 1.5) / (5 - 1.5)) * 100}%`}}
                          onInput={(e) => updateRangeProgress(e.target)}
                        />
                        <div className="w-12 text-center font-medium bg-base-200 px-2 py-1 rounded">
                          {imageGuidance}
                        </div>
                      </div>
                      <div className="text-xs opacity-70 mt-1">值越高越严格遵循提示词，值越低创造性越强</div>
                    </div>

                    {/* 安全容忍度设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">安全容忍度 (Safety Tolerance)</h3>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="0"
                          max="6"
                          step="1"
                          value={imageSafety}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            setImageSafety(value);
                            localStorage.setItem('aichat_image_safety', value.toString());
                            updateRangeProgress(e.target);
                          }}
                          className="range range-primary flex-1"
                          style={{"--range-shdw": `${((imageSafety - 0) / (6 - 0)) * 100}%`}}
                          onInput={(e) => updateRangeProgress(e.target)}
                        />
                        <div className="w-12 text-center font-medium bg-base-200 px-2 py-1 rounded">
                          {imageSafety}
                        </div>
                      </div>
                      <div className="text-xs opacity-70 mt-1">0 最严格，6 最宽松，控制内容过滤级别</div>
                    </div>

                    {/* 间隔参数设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">间隔参数 (Interval)</h3>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="1"
                          max="4"
                          step="0.1"
                          value={imageInterval}
                          onChange={(e) => {
                            const value = parseFloat(e.target.value);
                            setImageInterval(value);
                            localStorage.setItem('aichat_image_interval', value.toString());
                            updateRangeProgress(e.target);
                          }}
                          className="range range-primary flex-1"
                          style={{"--range-shdw": `${((imageInterval - 1) / (4 - 1)) * 100}%`}}
                          onInput={(e) => updateRangeProgress(e.target)}
                        />
                        <div className="w-12 text-center font-medium bg-base-200 px-2 py-1 rounded">
                          {imageInterval}
                        </div>
                      </div>
                      <div className="text-xs opacity-70 mt-1">引导控制的间隔参数，范围：1-4</div>
                    </div>

                    {/* 提示词上采样开关 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">提示词上采样</h3>
                      <div className="form-control bg-base-200 rounded-lg p-3">
                        <label className="label cursor-pointer">
                          <span className="label-text font-medium">启用提示词上采样</span>
                          <input
                            type="checkbox"
                            className="toggle toggle-primary"
                            checked={promptUpsampling}
                            onChange={(e) => {
                              setPromptUpsampling(e.target.checked);
                              localStorage.setItem('aichat_prompt_upsampling', e.target.checked.toString());
                            }}
                          />
                        </label>
                        <div className="text-xs opacity-70 mt-1">启用后将自动调整提示词以生成更具创意的内容</div>
                      </div>
                    </div>
                  </>
                ) : imageModel === 'black-forest-labs/FLUX.1-dev' ? (
                  <>
                    {/* 默认分辨率设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">默认分辨率</h3>
                      <select 
                        className="select select-bordered w-full"
                        value={imageSize}
                        onChange={(e) => handleImageSizeChange(e.target.value)}
                      >
                        {IMAGE_SIZES.map(size => (
                          <option key={size.value} value={size.value}>{size.label}</option>
                        ))}
                      </select>
                      <div className="text-xs opacity-70 mt-2">
                        选择图片生成的默认分辨率，也可以使用 /image 命令时通过 --size 参数指定其他分辨率
                      </div>
                    </div>

                    {/* 推理步骤数设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">推理步骤数 (Steps)</h3>
                      <div className="flex items-center gap-4">
                        <input
                          type="range"
                          min="2"
                          max="29"
                          step="1"
                          value={devImageSteps}
                          onChange={(e) => {
                            const value = parseInt(e.target.value);
                            setDevImageSteps(value);
                            localStorage.setItem('aichat_dev_image_steps', value.toString());
                            updateRangeProgress(e.target);
                          }}
                          className="range range-primary flex-1"
                          style={{"--range-shdw": `${((devImageSteps - 2) / (29 - 2)) * 100}%`}}
                          onInput={(e) => updateRangeProgress(e.target)}
                        />
                        <div className="w-12 text-center font-medium bg-base-200 px-2 py-1 rounded">
                          {devImageSteps}
                        </div>
                      </div>
                      <div className="text-xs opacity-70 mt-1">推理步骤数范围：2-29，步数越高细节越丰富</div>
                    </div>

                    {/* 提示增强开关 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">提示增强</h3>
                      <div className="form-control bg-base-200 rounded-lg p-3">
                        <label className="label cursor-pointer">
                          <span className="label-text font-medium">启用提示增强</span>
                          <input
                            type="checkbox"
                            className="toggle toggle-primary"
                            checked={devPromptEnhancement}
                            onChange={(e) => {
                              setDevPromptEnhancement(e.target.checked);
                              localStorage.setItem('aichat_dev_prompt_enhancement', e.target.checked.toString());
                            }}
                          />
                        </label>
                        <div className="text-xs opacity-70 mt-1">启用后将自动优化提示词以生成更好的结果</div>
                      </div>
                    </div>
                  </>
                ) : imageModel.includes('stable-diffusion-3') ? (
                  <>
                    {/* 默认分辨率设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">默认分辨率</h3>
                      <select 
                        className="select select-bordered w-full"
                        value={imageSize}
                        onChange={(e) => handleImageSizeChange(e.target.value)}
                      >
                        {IMAGE_SIZES.map(size => (
                          <option key={size.value} value={size.value}>{size.label}</option>
                        ))}
                      </select>
                      <div className="text-xs opacity-70 mt-2">
                        选择图片生成的默认分辨率，也可以使用 /image 命令时通过 --size 参数指定其他分辨率
                      </div>
                    </div>

                    {/* 提示增强开关 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">提示增强</h3>
                      <div className="form-control bg-base-200 rounded-lg p-3">
                        <label className="label cursor-pointer">
                          <span className="label-text font-medium">启用提示增强</span>
                          <input
                            type="checkbox"
                            className="toggle toggle-primary"
                            checked={sdPromptEnhancement}
                            onChange={(e) => {
                              setSdPromptEnhancement(e.target.checked);
                              localStorage.setItem('aichat_sd_prompt_enhancement', e.target.checked.toString());
                            }}
                          />
                        </label>
                        <div className="text-xs opacity-70 mt-1">启用后将自动优化提示词以生成更好的结果</div>
                      </div>
                    </div>
                  </>
                ) : imageModel.includes('FLUX.1-schnell') ? (
                  <>
                    {/* 默认分辨率设置 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">默认分辨率</h3>
                      <select 
                        className="select select-bordered w-full"
                        value={imageSize}
                        onChange={(e) => handleImageSizeChange(e.target.value)}
                      >
                        {IMAGE_SIZES.map(size => (
                          <option key={size.value} value={size.value}>{size.label}</option>
                        ))}
                      </select>
                      <div className="text-xs opacity-70 mt-2">
                        选择图片生成的默认分辨率，也可以使用 /image 命令时通过 --size 参数指定其他分辨率
                      </div>
                    </div>

                    {/* 提示增强开关 */}
                    <div>
                      <h3 className="text-lg font-medium mb-2">提示增强</h3>
                      <div className="form-control bg-base-200 rounded-lg p-3">
                        <label className="label cursor-pointer">
                          <span className="label-text font-medium">启用提示增强</span>
                          <input
                            type="checkbox"
                            className="toggle toggle-primary"
                            checked={schnellPromptEnhancement}
                            onChange={(e) => {
                              setSchnellPromptEnhancement(e.target.checked);
                              localStorage.setItem('aichat_schnell_prompt_enhancement', e.target.checked.toString());
                            }}
                          />
                        </label>
                        <div className="text-xs opacity-70 mt-1">启用后将自动优化提示词以生成更好的结果</div>
                      </div>
                    </div>
                  </>
                ) : (
                  // 其他模型的默认分辨率设置
                  <div>
                    <h3 className="text-lg font-medium mb-2">默认分辨率</h3>
                    <select 
                      className="select select-bordered w-full"
                      value={imageSize}
                      onChange={(e) => handleImageSizeChange(e.target.value)}
                    >
                      {IMAGE_SIZES.map(size => (
                        <option key={size.value} value={size.value}>{size.label}</option>
                      ))}
                    </select>
                    <div className="text-xs opacity-70 mt-2">
                      选择图片生成的默认分辨率，也可以使用 /image 命令时通过 --size 参数指定其他分辨率
                    </div>
                  </div>
                )}
              </div>

              <div className="divider"></div>

              {/* 视频参数设置 */}
              <div className="space-y-4">
                <h3 className="text-xl font-bold">视频参数设置</h3>
                
                {/* 视频模型选择 */}
                <div>
                  <h3 className="text-lg font-medium mb-2">视频生成模型</h3>
                  <select 
                    className="select select-bordered w-full"
                    value={videoModel}
                    onChange={(e) => {
                      const value = e.target.value;
                      setVideoModel(value);
                      localStorage.setItem('aichat_video_model', value);
                    }}
                  >
                    {VIDEO_MODELS.map(model => (
                      <option key={model} value={model}>{model}</option>
                    ))}
                  </select>
                  <div className="text-xs opacity-70 mt-2">
                    选择用于视频生成的模型，使用 /video 命令时会使用此模型
                  </div>
                </div>

                {/* 随机种子设置 */}
                <div>
                  <h3 className="text-lg font-medium mb-2">随机种子 (Seed)</h3>
                  <div className="flex items-center gap-0 w-full input-group flex">
                    <input
                      type="number"
                      min="0"
                      max="9999999999"
                      value={videoSeed}
                      onChange={(e) => {
                        const value = parseInt(e.target.value);
                        if (value >= 0 && value <= 9999999999) {
                          setVideoSeed(value);
                          localStorage.setItem('aichat_video_seed', value.toString());
                        }
                      }}
                      className="input input-bordered flex-grow h-11 px-4 transition-all focus:border-primary focus:ring-1 focus:ring-primary min-w-0"
                    />
                    <button
                      className="btn btn-square btn-outline h-11 min-w-[3.5rem]"
                      onClick={() => {
                        const newSeed = Math.floor(Math.random() * 9999999999);
                        setVideoSeed(newSeed);
                        localStorage.setItem('aichat_video_seed', newSeed.toString());
                      }}
                      title="生成新的随机种子"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                      </svg>
                    </button>
                  </div>
                  <div className="text-xs opacity-70 mt-1">设置随机种子以获得可重复的结果，留空则随机生成</div>
                </div>

                {/* 帮助信息 */}
                <div className="text-xs opacity-70 space-y-2">
                  <div className="settings-help-text">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>
                      生成的视频链接有效期为1小时，请及时下载保存
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Tab 4: 搜索设置 */}
          <div className={activeTab === 'search' ? '' : 'hidden'}>
            <div className="space-y-4 p-4">
              {/* 知识库功能开关已移除 */}

              {/* API密钥设置 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">API Key</span>
                </label>
                <div className="input-group w-full flex">
                  <input
                    type={showTavilyApiKey ? "text" : "password"}
                    className="input input-bordered flex-grow"
                    value={tavilyApiKey}
                    onChange={(e) => handleTavilyApiKeyChange(e.target.value)}
                    placeholder="tvly-..."
                  />
                  <button 
                    className="btn btn-square"
                    onClick={handleTavilyApiKeyPaste}
                    title="粘贴"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                  </button>
                  <button 
                    className="btn btn-square"
                    onClick={() => setShowTavilyApiKey(!showTavilyApiKey)}
                    title={showTavilyApiKey ? "隐藏" : "显示"}
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={showTavilyApiKey ? 
                        "M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" : 
                        "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"} />
                    </svg>
                  </button>
                </div>
                <label className="label">
                  <span className="label-text-alt">
                    <a href="https://app.tavily.com/home" target="_blank" rel="noopener noreferrer" className="link link-primary">
                      获取Tavily API密钥
                    </a>
                  </span>
                </label>
              </div>

              {/* 搜索主题 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">Search Topic</span>
                  <span className="label-text-alt opacity-60">选择搜索类别</span>
                </label>
                <select className="select select-bordered w-full" value={searchTopic} onChange={(e) => handleSearchTopicChange(e.target.value)}>
                  <option value="general">general</option>
                  <option value="news">news</option>
                </select>
              </div>

              {/* 搜索深度 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">Search Depth</span>
                  <span className="label-text-alt opacity-60">搜索深度影响结果质量和API消耗</span>
                </label>
                <select className="select select-bordered w-full" value={searchDepth} onChange={(e) => handleSearchDepthChange(e.target.value)}>
                  <option value="basic">basic</option>
                  <option value="advanced">advanced</option>
                </select>
              </div>

              {/* 最大结果数 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">Max Results</span>
                  <span className="label-text-alt opacity-60">返回的搜索结果数量</span>
                </label>
                <div className="flex gap-2 items-center">
                  <input 
                    type="number" 
                    className="input input-bordered w-24" 
                    min="1" 
                    max="20" 
                    value={maxSearchResults} 
                    onChange={(e) => handleMaxSearchResultsChange(parseInt(e.target.value))}
                  />
                  <div className="flex flex-col">
                    <button className="btn btn-xs" onClick={() => handleMaxSearchResultsChange(Math.min(maxSearchResults + 1, 20))}>
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                      </svg>
                    </button>
                    <button className="btn btn-xs" onClick={() => handleMaxSearchResultsChange(Math.max(maxSearchResults - 1, 1))}>
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>

              {/* 时间范围 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">Time Range</span>
                  <span className="label-text-alt opacity-60">限制结果时间范围</span>
                </label>
                <select className="select select-bordered w-full" value={timeRange || ""} onChange={(e) => handleTimeRangeChange(e.target.value || null)}>
                  <option value="day">day</option>
                  <option value="week">week</option>
                  <option value="month">month</option>
                  <option value="year">year</option>
                </select>
              </div>

              {/* 包含答案 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">Include Answer</span>
                  <span className="label-text-alt opacity-60">包含LLM生成的答案</span>
                </label>
                <select 
                  className="select select-bordered w-full" 
                  value={
                    includeAnswer === false ? "none" : 
                    includeAnswer === true ? "basic" :
                    includeAnswer
                  } 
                  onChange={(e) => {
                    const value = e.target.value;
                    handleIncludeAnswerChange(value);
                  }}
                >
                  <option value="none">none</option>
                  <option value="basic">basic</option>
                  <option value="advanced">advanced</option>
                </select>
              </div>

              {/* 包含图片 */}
              <div className="form-control">
                <label className="label cursor-pointer justify-start gap-2">
                  <input 
                    type="checkbox" 
                    className="checkbox checkbox-primary" 
                    checked={includeImages} 
                    onChange={(e) => handleIncludeImagesChange(e.target.checked)}
                  />
                  <span className="label-text font-medium">Include Images</span>
                  <span className="label-text-alt opacity-60 ml-2">包含相关图片搜索结果</span>
                </label>
              </div>

              {/* 包含图片描述（条件渲染） */}
              {includeImages && (
                <div className="form-control ml-6">
                  <label className="label cursor-pointer justify-start gap-2">
                    <input 
                      type="checkbox" 
                      className="checkbox checkbox-primary" 
                      checked={includeImageDescriptions} 
                      onChange={(e) => handleIncludeImageDescriptionsChange(e.target.checked)}
                      disabled={!includeImages}
                    />
                    <span className="label-text font-medium">Include Image Descriptions</span>
                    <span className="label-text-alt opacity-60 ml-2">为图片添加描述文本</span>
                  </label>
                </div>
              )}

              {/* 折叠部分：Additional Fields */}
              <div className="collapse collapse-arrow border border-base-300 bg-base-100 rounded-box">
                <input type="checkbox" /> 
                <div className="collapse-title text-lg font-medium">
                  Additional Fields
                </div>
                <div className="collapse-content space-y-4"> 
                  {/* 包含原始内容 */}
                  <div className="form-control">
                    <label className="label cursor-pointer justify-start gap-2">
                      <input 
                        type="checkbox" 
                        className="checkbox checkbox-primary" 
                        checked={includeRawContent} 
                        onChange={(e) => handleIncludeRawContentChange(e.target.checked)}
                      />
                      <span className="label-text font-medium">Include Raw Content</span>
                      <span className="label-text-alt opacity-60 ml-2">包含完整HTML内容</span>
                    </label>
                  </div>

                  {/* 天数（仅当Topic为news时显示） */}
                  {searchTopic === 'news' && (
                    <div className="form-control w-full">
                      <label className="label">
                        <span className="label-text font-medium">Days</span>
                        <span className="label-text-alt opacity-60">新闻搜索的天数范围</span>
                      </label>
                      <div className="flex gap-2 items-center">
                        <input 
                          type="number" 
                          className="input input-bordered w-24" 
                          min="1" 
                          max="30" 
                          value={days} 
                          onChange={(e) => handleDaysChange(parseInt(e.target.value))}
                        />
                        <div className="flex flex-col">
                          <button className="btn btn-xs" onClick={() => handleDaysChange(days + 1)}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" />
                            </svg>
                          </button>
                          <button className="btn btn-xs" onClick={() => handleDaysChange(Math.max(days - 1, 1))}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* 包含域名 */}
                  <div className="form-control w-full">
                    <label className="label">
                      <span className="label-text font-medium">Include Domains</span>
                      <span className="label-text-alt opacity-60">指定包含的域名</span>
                    </label>
                    <div className="flex flex-col gap-2">
                      {includeDomains.map((domain, index) => (
                        <div key={index} className="flex items-center gap-2">
                          <input
                            type="text"
                            className="input input-bordered flex-grow"
                            value={domain}
                            onChange={(e) => handleIncludeDomainChange(index, e.target.value)}
                            placeholder="example.com"
                          />
                          <button 
                            className="btn btn-square btn-sm" 
                            onClick={() => handleRemoveIncludeDomain(index)}
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      ))}
                      <button 
                        className="btn btn-outline btn-sm" 
                        onClick={handleAddIncludeDomain}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>

                  {/* 排除域名 */}
                  <div className="form-control w-full">
                    <label className="label">
                      <span className="label-text font-medium">Exclude Domains</span>
                      <span className="label-text-alt opacity-60">指定排除的域名</span>
                    </label>
                    <div className="flex flex-col gap-2">
                      {excludeDomains.map((domain, index) => (
                        <div key={index} className="flex items-center gap-2">
                          <input
                            type="text"
                            className="input input-bordered flex-grow"
                            value={domain}
                            onChange={(e) => handleExcludeDomainChange(index, e.target.value)}
                            placeholder="example.com"
                          />
                          <button 
                            className="btn btn-square btn-sm" 
                            onClick={() => handleRemoveExcludeDomain(index)}
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      ))}
                      <button 
                        className="btn btn-outline btn-sm" 
                        onClick={handleAddExcludeDomain}
                      >
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          {/* Tab 5: 交互设置 */}
          <div className={activeTab === 'interactive' ? '' : 'hidden'}>
            <div className="space-y-4 p-4">
              <h3 className="text-xl font-bold">语音合成设置</h3>
              
              {/* 音色选择 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">TTS 音色</span>
                  <span className="label-text-alt opacity-60">选择语音合成音色</span>
                </label>
                <select 
                  className="select select-bordered w-full" 
                  value={selectedTtsVoice}
                  onChange={(e) => handleTtsVoiceChange(e.target.value)}
                >
                  {TTS_VOICES.map(voice => (
                    <option key={voice.id} value={voice.id}>
                      {voice.name} ({voice.language})
                    </option>
                  ))}
                </select>
                <label className="label">
                  <span className="label-text-alt opacity-60">选择语音合成使用的音色，适用于消息播放和流式TTS</span>
                </label>
              </div>
              
              {/* 添加自定义Voice ID设置 */}
              <div className="form-control w-full">
                <label className="label">
                  <span className="label-text font-medium">自定义 Voice ID</span>
                  <span className="label-text-alt opacity-60">自定义语音合成音色ID</span>
                </label>
                <div className="flex gap-2 items-center">
                  <input 
                    type="text" 
                    placeholder="例如: cosyvoice-goldie06-b7c34b5f368b469c9f1ab69daef9525b" 
                    className="input input-bordered flex-grow" 
                    value={customVoiceId}
                    onChange={(e) => {
                      const value = e.target.value;
                      setCustomVoiceId(value);
                      localStorage.setItem('aichat_custom_voice_id', value);
                      
                      // 如果当前已启用自定义Voice ID，同时更新ttsVoiceSettings
                      if (useCustomVoice && value.trim() !== '') {
                        try {
                          const ttsSettings = {
                            selectedVoice: value,
                            isCustomVoice: true,
                            lastUpdated: Date.now()
                          };
                          localStorage.setItem('ttsVoiceSettings', JSON.stringify(ttsSettings));
                        } catch (e) {
                          console.error('保存自定义TTS设置失败:', e);
                        }
                      }
                    }}
                  />
                  <input 
                    type="checkbox" 
                    className="toggle toggle-primary" 
                    checked={useCustomVoice}
                    onChange={(e) => {
                      const checked = e.target.checked;
                      setUseCustomVoice(checked);
                      localStorage.setItem('aichat_use_custom_voice', checked ? 'true' : 'false');
                      
                      // 更新ttsVoiceSettings以反映当前选择
                      try {
                        const ttsSettings = {
                          selectedVoice: checked && customVoiceId.trim() !== '' 
                            ? customVoiceId 
                            : selectedTtsVoice,
                          isCustomVoice: checked,
                          lastUpdated: Date.now()
                        };
                        localStorage.setItem('ttsVoiceSettings', JSON.stringify(ttsSettings));
                      } catch (e) {
                        console.error('更新TTS设置失败:', e);
                      }
                    }}
                  />
                </div>
                <label className="label">
                  <span className="label-text-alt">勾选后将使用此ID，而非下拉菜单中的音色</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* 模板编辑对话框 */}
      {(isAddingTemplate || editingTemplateId) && (
        <div className="template-edit-dialog">
          <div className="template-edit-content">
            <h2 className="text-xl font-bold mb-4 px-2">
              {isAddingTemplate ? '添加新模板' : '编辑模板'}
            </h2>
            
            <div className="space-y-4 px-2">
              <div>
                <label className="label">
                  <span className="label-text">模板名称</span>
                </label>
                <input
                  type="text"
                  className="input input-bordered w-full"
                  value={templateName}
                  onChange={(e) => setTemplateName(e.target.value)}
                  placeholder="输入模板名称..."
                />
              </div>
              
              <div>
                <label className="label">
                  <span className="label-text">模板内容</span>
                </label>
                <textarea
                  className="textarea textarea-bordered w-full h-48"
                  value={templateContent}
                  onChange={(e) => setTemplateContent(e.target.value)}
                  placeholder="输入模板内容..."
                />
              </div>
              
              <div className="flex justify-end gap-2">
                <button 
                  className="btn"
                  onClick={handleCancelEditTemplate}
                >
                  取消
                </button>
                <button 
                  className="gold-save-btn"
                  onClick={handleSaveTemplate}
                >
                  保存
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}; 